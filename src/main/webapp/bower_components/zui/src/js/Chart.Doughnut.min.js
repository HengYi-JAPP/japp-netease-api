(function($){"use strict";var root=$&&$.zui?$.zui:this,Chart=root.Chart,helpers=Chart.helpers;var defaultConfig={segmentShowStroke:true,segmentStrokeColor:"#fff",segmentStrokeWidth:1,percentageInnerCutout:50,scaleShowLabels:false,scaleLabel:"<%=value%>",scaleLabelPlacement:"auto",animationSteps:60,animationEasing:"easeOutBounce",animateRotate:true,animateScale:false,legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<segments.length; i++){%><li><span style="background-color:<%=segments[i].fillColor%>"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>'};Chart.Type.extend({name:"Doughnut",defaults:defaultConfig,initialize:function(data){this.segments=[];this.outerRadius=(helpers.min([this.chart.width,this.chart.height])-this.options.segmentStrokeWidth/2)/2;this.SegmentArc=Chart.Arc.extend({ctx:this.chart.ctx,x:this.chart.width/2,y:this.chart.height/2});if(this.options.showTooltips){helpers.bindEvents(this,this.options.tooltipEvents,function(evt){var activeSegments=evt.type!=="mouseout"?this.getSegmentsAtEvent(evt):[];helpers.each(this.segments,function(segment){segment.restore(["fillColor"])});helpers.each(activeSegments,function(activeSegment){activeSegment.fillColor=activeSegment.highlightColor});this.showTooltip(activeSegments)})}this.calculateTotal(data);helpers.each(data,function(datapoint,index){this.addData(datapoint,index,true)},this);this.render()},getSegmentsAtEvent:function(e){var segmentsArray=[];var location=helpers.getRelativePosition(e);helpers.each(this.segments,function(segment){if(segment.inRange(location.x,location.y))segmentsArray.push(segment)},this);return segmentsArray},addData:function(segment,atIndex,silent){if($.zui&&$.zui.Color&&$.zui.Color.get){var color=new $.zui.Color.get(segment.color);segment.color=color.toCssStr();if(!segment.highlight)segment.highlight=color.lighten(5).toCssStr()}var index=atIndex||this.segments.length;this.segments.splice(index,0,new this.SegmentArc({id:typeof segment.id==="undefined"?index:segment.id,value:segment.value,outerRadius:this.options.animateScale?0:this.outerRadius,innerRadius:this.options.animateScale?0:this.outerRadius/100*this.options.percentageInnerCutout,fillColor:segment.color,highlightColor:segment.highlight||segment.color,showStroke:this.options.segmentShowStroke,strokeWidth:this.options.segmentStrokeWidth,strokeColor:this.options.segmentStrokeColor,startAngle:Math.PI*1.5,circumference:this.options.animateRotate?0:this.calculateCircumference(segment.value),showLabel:segment.showLabel!==false,label:segment.label}));if(!silent){this.reflow();this.update()}},calculateCircumference:function(value){return Math.PI*2*(Math.abs(value)/this.total)},calculateTotal:function(data){this.total=0;helpers.each(data,function(segment){this.total+=Math.abs(segment.value)},this)},update:function(){this.calculateTotal(this.segments);helpers.each(this.activeElements,function(activeElement){activeElement.restore(["fillColor"])});helpers.each(this.segments,function(segment){segment.save()});this.render()},removeData:function(atIndex){var indexToDelete=helpers.isNumber(atIndex)?atIndex:this.segments.length-1;this.segments.splice(indexToDelete,1);this.reflow();this.update()},reflow:function(){helpers.extend(this.SegmentArc.prototype,{x:this.chart.width/2,y:this.chart.height/2});this.outerRadius=(helpers.min([this.chart.width,this.chart.height])-this.options.segmentStrokeWidth/2)/2;helpers.each(this.segments,function(segment){segment.update({outerRadius:this.outerRadius,innerRadius:this.outerRadius/100*this.options.percentageInnerCutout})},this)},drawLabel:function(segment,easeDecimal,labelPosMap){var options=this.options;var middleAngle=(segment.endAngle+segment.startAngle)/2;var placement=options.scaleLabelPlacement;if(placement!=="inside"&&placement!=="outside"){if(this.chart.width-this.chart.height>50){if(segment.circumference<Math.PI/18){placement="outside"}}}var x=Math.cos(middleAngle)*segment.outerRadius,y=Math.sin(middleAngle)*segment.outerRadius,text=helpers.template(options.scaleLabel,{value:typeof easeDecimal==="undefined"?segment.value:Math.round(easeDecimal*segment.value),label:segment.label});var ctx=this.chart.ctx;ctx.font=helpers.fontString(options.scaleFontSize,options.scaleFontStyle,options.scaleFontFamily);ctx.textBaseline="middle";ctx.textAlign="center";var textWidth=ctx.measureText(text).width;var chartWidthHalf=this.chart.width/2;var chartHeightHalf=this.chart.height/2;if(placement==="outside"){var isRight=x>=0;var lineX=x+chartWidthHalf;var lineY=y+chartHeightHalf;ctx.textAlign=isRight?"left":"right";ctx.measureText(text).width;if(isRight){x=Math.max(chartWidthHalf+segment.outerRadius+10,x+30+chartWidthHalf)}else{x=Math.min(chartWidthHalf-segment.outerRadius-10,x-30+chartWidthHalf)}var textHeight=options.scaleFontSize*(options.scaleLineHeight||1);var labelPos=Math.round((y*.8+chartHeightHalf)/textHeight)+1;var maxPos=Math.floor(this.chart.width/textHeight)+1;var labelPosDirection=isRight?1:-1;if(labelPosMap[labelPos*labelPosDirection]){if(labelPos>1)labelPos--;else labelPos++}if(labelPosMap[labelPos*labelPosDirection])return;y=(labelPos-1)*textHeight+options.scaleFontSize/2;labelPosMap[labelPos*labelPosDirection]=true;ctx.beginPath();ctx.moveTo(lineX,lineY);ctx.lineTo(x,y);x=isRight?x+5:x-5;ctx.lineTo(x,y);ctx.strokeStyle=$.zui&&$.zui.Color?new $.zui.Color(segment.fillColor).fade(40).toCssStr():segment.fillColor;ctx.strokeWidth=options.scaleLineWidth;ctx.stroke();ctx.fillStyle=segment.fillColor}else{x=x*.7+chartWidthHalf;y=y*.7+chartHeightHalf;ctx.fillStyle=$.zui&&$.zui.Color?new $.zui.Color(segment.fillColor).contrast().toCssStr():"#fff"}ctx.fillText(text,x,y)},draw:function(easeDecimal){var animDecimal=easeDecimal?easeDecimal:1;this.clear();var labelPositionMap;helpers.each(this.segments,function(segment,index){segment.transition({circumference:this.calculateCircumference(segment.value),outerRadius:this.outerRadius,innerRadius:this.outerRadius/100*this.options.percentageInnerCutout},animDecimal);segment.endAngle=segment.startAngle+segment.circumference;segment.draw();if(index===0){segment.startAngle=Math.PI*1.5}if(index<this.segments.length-1){this.segments[index+1].startAngle=segment.endAngle}},this);if(this.options.scaleShowLabels){var segmentsArray=this.segments.slice().sort(function(a,b){return b.value-a.value});var labelPositionMap={};helpers.each(segmentsArray,function(segment,index){if(segment.showLabel)this.drawLabel(segment,easeDecimal,labelPositionMap)},this)}}});Chart.types.Doughnut.extend({name:"Pie",defaults:helpers.merge(defaultConfig,{percentageInnerCutout:0})});$.fn.pieChart=function(data,options){var pieCharts=[];this.each(function(){var $this=$(this);pieCharts.push(new Chart(this.getContext("2d")).Pie(data,$.extend($this.data(),options)))});return pieCharts.length===1?pieCharts[0]:pieCharts};$.fn.doughnutChart=function(data,options){var doughnutCharts=[];this.each(function(){var $this=$(this);doughnutCharts.push(new Chart(this.getContext("2d")).Doughnut(data,$.extend($this.data(),options)))});return doughnutCharts.length===1?doughnutCharts[0]:doughnutCharts}}).call(this,jQuery);